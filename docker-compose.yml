version: '3.7'

services: 
  elasticsearch:
    container_name: elasticsearch
    image: docker.elastic.co/elasticsearch/elasticsearch:7.2.0
    restart: always
    environment: 
      - "ES_JAVA_OPTS=-Xms7g -Xmx7g"
      - discovery.type=single-node
    volumes:
      - elasticsearchdata:/usr/share/elasticsearch/data
      - elasticsearchconfig:/usr/share/elasticsearch/config
      - elasticsearchlogs:/usr/share/elasticsearch/logs
    ulimits: 
      memlock:      # esta configuraci√≥n indica que no tendra liminte 
        soft: -1    # ni minimo ni maximo de memoria
        hard: -1    #
    volumes: 
      - $PWD/elasticsearch/data:/usr/share/elasticsearch/data # volumen para evitar perder las configuraciones ni la informacion
    ports: 
      - 9200:9200
      - 9300:9300
    networks:
      - ext

  logstage:
    container_name: logstage
    image: logstash:7.14.0
    restart: always
    volumes: 
      - $PWD/logstage/pipeline:/usr/share/logstage/pipeline # volumen para guardar los pipelines de la configuracion
    networks:
      - ext

  kibana:
    container_name: kibana
    image: kibana:7.14.0
    restart: always
    ports: 
      - 5601:5601
    networks:
      - ext

volumes:
  elasticsearchdata:
    driver: local
    driver_opts:
      type: nfs
      device: ":/volumes/elasticsearch/data"
      o: "addr=${NFSSERVER},vers=4,rw"
  elasticsearchconfig:
    driver: local
    driver_opts:
      type: nfs
      device: ":/volumes/elasticsearch/config"
      o: "addr=${NFSSERVER},vers=4,rw"
  elasticsearchlogs:
    driver: local
    driver_opts:
      type: nfs
      device: ":/volumes/elasticsearch/logs"
      o: "addr=${NFSSERVER},vers=4,rw"

networks:
  ext:      